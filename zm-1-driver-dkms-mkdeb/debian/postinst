#!/bin/sh
# Copyright (C) 2002-2005 Flavio Stanchina
# Copyright (C) 2005-2006 Aric Cyr
# Copyright (C) 2007 Mario Limonciello
# Copyright (C) 2009 Alberto Milone

set -e

NAME=MODULE_NAME
PACKAGE_NAME=$NAME-dkms
DEB_NAME=$(echo $PACKAGE_NAME | sed 's,_,-,')
CVERSION=`dpkg-query -W -f='${Version}' $DEB_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`
ARCH=`dpkg --print-architecture`

dkms_configure () {
	for POSTINST in /usr/lib/dkms/common.postinst "/usr/share/$PACKAGE_NAME/postinst"; do
		if [ -f "$POSTINST" ]; then
			"$POSTINST" "$NAME" "$CVERSION" "/usr/share/$PACKAGE_NAME" "$ARCH" "$2"
			return $?
		fi
		echo "WARNING: $POSTINST does not exist." >&2
	done
	echo "ERROR: DKMS version is too old and $PACKAGE_NAME was not" >&2
	echo "built with legacy DKMS support." >&2
	echo "You must either rebuild $PACKAGE_NAME with legacy postinst" >&2
	echo "support or upgrade DKMS to a more current version." >&2
	return 1
}

gen_log_package () {
    echo "Generating log package"
    LOG_PACKAGE_NAME="logPkg_`date "+%y%m%d%H%M%S"`@install"
    LOG_PACKAGE_DIR=/usr/local/share/Zylia/ZYLIA\ Control\ Panel/${LOG_PACKAGE_NAME}
    mkdir -p "${LOG_PACKAGE_DIR}"
    cp /var/log/syslog "${LOG_PACKAGE_DIR}/"
    chmod 0644 "${LOG_PACKAGE_DIR}/syslog"
    touch "${LOG_PACKAGE_DIR}/cmd.log"
    uname -a >> "${LOG_PACKAGE_DIR}/cmd.log"
    echo "\n\nContents:\n    1. lsmod\n    2. modinfo\n    3. dmesg\n\n" >> "${LOG_PACKAGE_DIR}/cmd.log"
    echo "\n#################\n1. lsmod\n#################\n" >> "${LOG_PACKAGE_DIR}/cmd.log"
    lsmod >> "${LOG_PACKAGE_DIR}/cmd.log"
    echo "\n#################\n2. modinfo\n#################\n" >> "${LOG_PACKAGE_DIR}/cmd.log"
    modinfo zm_1_driver >> "${LOG_PACKAGE_DIR}/cmd.log"
    echo "\n#################\n3. dmesg\n#################\n" >> "${LOG_PACKAGE_DIR}/cmd.log"
    dmesg >> "${LOG_PACKAGE_DIR}/cmd.log"
}

case "$1" in
	configure)
		dkms_configure
        gen_log_package
		STORE_VOLUME_C="/usr/local/share/Zylia/store_volume.c"
		STORE_VOLUME="/usr/local/share/Zylia/store_volume"
		echo "#include <unistd.h>" > $STORE_VOLUME_C
		echo "int main() { char *argv[] = {\"/usr/sbin/alsactl\", \"store\", NULL}; char *envp[] = {NULL}; return execve(\"/usr/sbin/alsactl\", argv, envp); } " >> $STORE_VOLUME_C
		gcc $STORE_VOLUME_C -o $STORE_VOLUME
		rm $STORE_VOLUME_C
		chmod +x $STORE_VOLUME
		chmod u+s $STORE_VOLUME
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;

	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
